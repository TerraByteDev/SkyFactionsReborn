import org.apache.tools.ant.filters.ReplaceTokens

buildscript {
    dependencies {
        classpath 'org.xerial:sqlite-jdbc:3.47.0.0'
    }
}

plugins {
    id 'io.papermc.paperweight.userdev' version '1.7.4'
    id 'com.gradleup.shadow' version '8.3.5'
    id 'java'
    id "xyz.jpenilla.run-paper" version "2.3.1"
    id 'org.flywaydb.flyway' version '10.21.0'
    id "org.jooq.jooq-codegen-gradle" version "3.19.15"
//    id 'nu.studer.jooq' version '9.0'
}

group = 'net.skullian.skyfactions'
version = '1.0-SNAPSHOT'

java {
    toolchain.languageVersion = JavaLanguageVersion.of(21)
}

repositories {
    mavenCentral()

    maven {
        name = "papermc-repo"
        url = "https://repo.papermc.io/repository/maven-public/"
    }

    maven {
        name = "sonatype"
        url = "https://oss.sonatype.org/content/groups/public/"
    }

    maven {
        name = "EngineHub"
        url = "https://maven.enginehub.org/repo/"
    }

    maven {
        name = "PlaceholderAPI"
        url = "https://repo.extendedclip.com/content/repositories/placeholderapi/"
    }

    maven {
        name = "XenonDevs Releases"
        url = "https://repo.xenondevs.xyz/releases"
    }

    maven {
        name = "CodeMC Public"
        url = "https://repo.codemc.org/repository/maven-public/"
    }

    maven {
        name = "JitPack"
        url = "https://jitpack.io"
    }

    maven {
        name = "EssentialsX Releases"
        url = "https://repo.essentialsx.net/releases/"
    }

    maven {
        name = "eldonexus"
        url = uri("https://eldonexus.de/repository/maven-releases/")
    }

    maven {
        name = "Lumine Public"
        url = "https://mvn.lumine.io/repository/maven-public/"
    }

    maven {
        name = "Pyr's Snapshots"
        url = "https://repo.pyr.lol/snapshots"
    }

    maven {
        name = "JitPack"
        url "https://jitpack.io"
    }

    maven {
        name = "EvokeGames Snapshots"
        url = "https://maven.evokegames.gg/snapshots"
    }

    maven {
        name = "SpigotMC Snapshots"
        url = "https://hub.spigotmc.org/nexus/content/repositories/snapshots/"
    }

    maven {
        name = "FancyNPCs Repository"
        url = "https://repo.fancyplugins.de/releases"
    }

    maven {
        name = "CraftationGaming Chaos"
        url = "https://repo.craftationgaming.com/chaos"
    }

    maven {
        name = "Oraxen Repository"
        url = "https://repo.oraxen.com/releases"
    }
}

dependencies {
    compileOnly("io.papermc.paper:paper-api:1.21.1-R0.1-SNAPSHOT")

    compileOnly("org.projectlombok:lombok:1.18.34")
    annotationProcessor("org.projectlombok:lombok:1.18.34")

    compileOnly("me.clip:placeholderapi:2.11.6")
    compileOnly("com.zaxxer:HikariCP:6.1.0")
    compileOnly("xyz.xenondevs.invui:invui:1.41")

    implementation(platform("com.intellectualsites.bom:bom-newest:1.50"))
    compileOnly("com.fastasyncworldedit:FastAsyncWorldEdit-Core")
    compileOnly("com.fastasyncworldedit:FastAsyncWorldEdit-Bukkit")

    compileOnly("com.sk89q.worldguard:worldguard-bukkit:7.1.0-SNAPSHOT")
    compileOnly("org.xerial:sqlite-jdbc:3.47.0.0")
    compileOnly("net.dv8tion:JDA:5.2.1")
    compileOnly("fr.skytasul:jukebox:1.20.8")
    compileOnly("com.github.koca2000:NoteBlockAPI:1.6.2")
    compileOnly("com.fasterxml.jackson.core:jackson-databind:2.18.1")
    compileOnly("com.mojang:authlib:3.3.39")
    compileOnly("com.jeff-media:custom-block-data:2.2.3")
    compileOnly("io.lumine:Mythic-Dist:5.7.2")
    compileOnly("net.objecthunter:exp4j:0.4.8")
    compileOnly("com.github.yannicklamprecht:worldborderapi:1.213.0:dev")
    compileOnly("com.github.retrooper:packetevents-spigot:2.6.0")
    implementation("me.tofaa.entitylib:spigot:2.4.11-SNAPSHOT")
    compileOnly("dev.dejvokep:boosted-yaml:1.3.7")
    compileOnly("org.incendo:cloud-paper:2.0.0-SNAPSHOT")
    compileOnly("org.incendo:cloud-core:2.0.0")
    compileOnly("org.incendo:cloud-annotations:2.0.0")
    compileOnly("lol.pyr:znpcsplus-api:2.0.0-SNAPSHOT")
    compileOnly("net.kyori:adventure-text-minimessage:4.17.0")
    compileOnly("de.oliver:FancyNpcs:2.4.0")
    compileOnly("com.github.MilkBowl:VaultAPI:1.7.1")
    compileOnly("me.RockinChaos.itemjoin:ItemJoin:6.1.0-RELEASE")
    compileOnly("io.th0rgal:oraxen:1.184.0")
    compileOnly("com.github.LoneDev6:API-ItemsAdder:3.6.1")

    paperweight.paperDevBundle("1.21.1-R0.1-SNAPSHOT")

    compileOnly("org.jooq:jooq:3.19.15")
//    jooqGenerator("org.xerial:sqlite-jdbc:3.47.0.0")
    jooqCodegen("org.xerial:sqlite-jdbc:3.47.0.0")
}


tasks {
    runServer {
        downloadPlugins {
            modrinth("FastAsyncWorldEdit", "2.12.0")
            modrinth("ViaVersion", "5.1.1")
            modrinth("PacketEvents", "2.6.0")
            modrinth("pworlds", "2.0.12")

            hangar("PlaceholderAPI", "2.11.6")

            github("yannicklamprecht", "WorldBorderAPI", "1.213.0", "worldborderapi-1.213.0.jar")
            github("xtkq-is-not-available", "VoidGen", "v2.2.1", "VoidGen-2.2.1.jar")
            github("MilkBowl", "Vault", "1.7.3", "Vault.jar")

            url("https://ci.enginehub.org/repository/download/bt11/25367:id/worldguard-bukkit-7.0.12-dist.jar?branch=version/7.0.x&guest=1")
            url("https://download.luckperms.net/1561/bukkit/loader/LuckPerms-Bukkit-5.4.146.jar")
        }
        minecraftVersion("1.21")
    }
}

def targetJavaVersion = 21
java {
    def javaVersion = JavaVersion.toVersion(targetJavaVersion)
    sourceCompatibility = javaVersion
    targetCompatibility = javaVersion
    if (JavaVersion.current() < javaVersion) {
        toolchain.languageVersion = JavaLanguageVersion.of(targetJavaVersion)
    }
}

configurations {
    flywayMigration
}

flyway {
    configurations = ['flywayMigration']
    url = 'jdbc:sqlite:file:./assets/data.sqlite3'
    user = 'sa'
    password = ''
}

jooq {
    configuration {
        logging = org.jooq.meta.jaxb.Logging.DEBUG
        jdbc {
            driver = 'org.sqlite.JDBC'
            url = flyway.url
            user = flyway.user
            password = flyway.password
        }
        generator {
            name = 'org.jooq.codegen.DefaultGenerator'
            database {
                name = 'org.jooq.meta.sqlite.SQLiteDatabase'
                includes = '.*'
                excludes = ''
            }
            generate {
                deprecated = false
                records = true
                immutablePojos = true
                fluentSetters = true
            }
            target {
                packageName = 'net.skullian.skyfactions.database'
                directory = 'src/main/java/'
                clean = false
            }
        }
    }
}

//jooq {
//    configurations {
//        main {
//            generateSchemaSourceOnCompilation = false
//            generationTool {
//                logging = org.jooq.meta.jaxb.Logging.DEBUG
//                jdbc {
//                    driver = 'org.sqlite.JDBC'
//                    url = flyway.url
//                    user = flyway.user
//                    password = flyway.password
//                }
//                generator {
//                    name = 'org.jooq.codegen.DefaultGenerator'
//                    database {
//                        name = 'org.jooq.meta.sqlite.SQLiteDatabase'
//                        includes = '.*'
//                        excludes = ''
//                    }
////                    database {
////                        name = "org.jooq.meta.extensions.ddl.DDLDatabase"
////                        properties {
////                            property {
////                                key = "scripts"
////                                value = "src/main/resources/db/schema.sql"
////                            }
////                            property {
////                                key = "sort"
////                                value = "flyway"
////                            }
////                            property {
////                                key = "unqualifiedSchema"
////                                value = "none"
////                            }
////                            property {
////                                key = "defaultNameCase"
////                                value = "as_is"
////                            }
////                        }
////                    }
//                    generate {
//                        deprecated = false
//                        records = true
//                        immutablePojos = true
//                        fluentSetters = true
//                    }
//                    target {
//                        packageName = 'net.skullian.skyfactions.database'
//                        directory = 'src/main/java/'
//                    }
//                    strategy.name = 'org.jooq.codegen.DefaultGeneratorStrategy'
//                }
//            }
//        }
//    }
//}

//tasks.named('generateJooq').configure {
//    dependsOn tasks.named('flywayMigrate')
//    inputs.files(fileTree('src/main/resources/db/migration'))
//            .withPropertyName('migrations')
//            .withPathSensitivity(PathSensitivity.RELATIVE)
//    allInputsDeclared = true
//}

tasks.named('jooqCodegen').configure {
    dependsOn tasks.named('flywayMigrate')
    inputs.files(fileTree('src/main/resources/db/migration'))
            .withPropertyName('migrations')
            .withPathSensitivity(PathSensitivity.RELATIVE)
}

tasks.withType(JavaCompile).configureEach {
    options.encoding = 'UTF-8'

    if (targetJavaVersion >= 10 || JavaVersion.current().isJava10Compatible()) {
        options.release.set(targetJavaVersion)
    }
}

processResources {
    filter ReplaceTokens, tokens: [
            "version": project.property("version")
    ]
}
